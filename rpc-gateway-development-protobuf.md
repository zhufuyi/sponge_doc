grpcç½‘å…³æ˜¯grpcæœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œå®ƒå¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›è´Ÿè½½å‡è¡¡ã€è·¯ç”±ã€å®‰å…¨ã€ç›‘æ§ç­‰åŠŸèƒ½ï¼Œä»è€Œæé«˜å¾®æœåŠ¡çš„æ€§èƒ½ã€å¯ç”¨æ€§å’Œå®‰å…¨æ€§ã€‚

**ä¸»è¦ä½œç”¨ï¼š**

- é€šå¸¸ä½äºå®¢æˆ·ç«¯å’ŒgrpcæœåŠ¡ä¹‹é—´ï¼Œå®ƒå¯ä»¥å°†å®¢æˆ·ç«¯çš„è¯·æ±‚å‡åŒ€åœ°åˆ†å‘åˆ°å¤šä¸ªgrpcæœåŠ¡ï¼Œä»è€Œæé«˜å¾®æœåŠ¡çš„ååé‡å’Œå¯ç”¨æ€§ã€‚
- æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„grpcæœåŠ¡ï¼Œä»è€Œç®€åŒ–å®¢æˆ·ç«¯çš„å¼€å‘ã€‚
- æä¾›èº«ä»½è®¤è¯ã€æˆæƒã€åŠ å¯†ç­‰å®‰å…¨åŠŸèƒ½ï¼Œä»è€Œä¿æŠ¤grpcæœåŠ¡çš„å®‰å…¨ã€‚
- æ”¶é›†grpcæœåŠ¡çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼Œå¹¶æä¾›ç›‘æ§åŠŸèƒ½ï¼Œä»è€Œå¸®åŠ©ç”¨æˆ·ç®¡ç†grpcæœåŠ¡ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**

- åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œgrpcç½‘å…³å¯ä»¥ä½œä¸ºå¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œç®€åŒ–å®¢æˆ·ç«¯çš„å¼€å‘ï¼Œå¹¶æé«˜å¾®æœåŠ¡çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
- åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œgrpcç½‘å…³å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€è·¯ç”±ã€å®‰å…¨ç­‰åŠŸèƒ½ï¼Œä»è€Œæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚
- åœ¨è·¨å¹³å°ç³»ç»Ÿç§ï¼Œgrpcç½‘å…³å¯ä»¥æ”¯æŒä¸åŒå¹³å°çš„grpcæœåŠ¡ï¼Œä»è€Œå¸®åŠ©ç”¨æˆ·æ„å»ºè·¨å¹³å°çš„grpcç³»ç»Ÿã€‚

è¿™é‡Œ`â“¹åŸºäºprotobufåˆ›å»ºgrpcç½‘å…³æœåŠ¡`æ˜¯grpcæœåŠ¡çš„ç»Ÿä¸€å…¥å£çš„webæœåŠ¡ï¼Œä¸‹é¢ä»‹ç»grpcç½‘å…³æœåŠ¡å¼€å‘å…·ä½“æµç¨‹ã€‚

<br>

### ğŸ·å‰æœŸå‡†å¤‡

å¼€å‘grpcç½‘å…³æœåŠ¡å‰å‡†å¤‡ï¼š

- å·²å®‰è£…sponge
- protoæ–‡ä»¶ï¼Œä¾‹å¦‚[user_gw.proto](https://github.com/zhufuyi/sponge_examples/blob/main/5_micro-gin-rpc-gateway/user-gateway/api/user_gw/v1/user_gw.proto)ã€‚
- grpcæœåŠ¡[user](https://github.com/zhufuyi/sponge_examples/tree/main/4_micro-grpc-protobuf)ï¼Œä¹Ÿå¯ä»¥ä¸´æ—¶å¿«é€Ÿåˆ›å»ºä¸€ä¸ªgrpcæœåŠ¡ï¼Œç‚¹å‡»æŸ¥çœ‹<a href="/zh-cn/microservice-development-protobuf?id=%f0%9f%94%b9%e5%88%9b%e5%bb%bagrpc%e6%9c%8d%e5%8a%a1" target="_blank">åˆ›å»ºgrpcæœåŠ¡æ–‡æ¡£</a>ã€‚

æ‰“å¼€ç»ˆç«¯ï¼Œå¯åŠ¨sponge UIç•Œé¢æœåŠ¡ï¼š

```bash
sponge run
```

åœ¨æµè§ˆå™¨è®¿é—® http://localhost:24631 ï¼Œè¿›å…¥spongeç”Ÿæˆä»£ç çš„UIç•Œé¢ã€‚

<br>

### ğŸ·åˆ›å»ºgrpcç½‘å…³æœåŠ¡é¡¹ç›®

è¿›å…¥spongeçš„UIç•Œé¢ï¼Œç‚¹å‡»å·¦è¾¹èœå•æ ã€Protobufã€‘-->ã€åˆ›å»ºgrpcç½‘å…³é¡¹ç›®ã€‘ï¼Œé€‰æ‹©protoæ–‡ä»¶(å¯å¤šé€‰)ï¼Œæ¥ç€å¡«å†™å…¶ä»–å‚æ•°ï¼Œé¼ æ ‡æ”¾åœ¨é—®å·`?`ä½ç½®å¯ä»¥æŸ¥çœ‹å‚æ•°è¯´æ˜ï¼Œå¡«å†™å®Œå‚æ•°åï¼Œç‚¹å‡»æŒ‰é’®`ä¸‹è½½ä»£ç `ç”Ÿæˆgrpcç½‘å…³æœåŠ¡é¡¹ç›®ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![micro-rpc-gw-pb](assets/images/micro-rpc-gw-pb.png)

> [!tip] ç­‰ä»·å‘½ä»¤ **sponge micro rpc-gw-pb --module-name=edusys --server-name=edusys --project-name=edusys --protobuf-file=./user_gw.proto**

> [!tip] è§£å‹çš„grpcç½‘å…³æœåŠ¡ä»£ç ç›®å½•åç§°çš„æ ¼å¼æ˜¯`æœåŠ¡åç§°-ç±»å‹-æ—¶é—´`ï¼Œå¯ä»¥ä¿®æ”¹ç›®å½•åç§°(ä¾‹å¦‚æŠŠåç§°ä¸­çš„ç±»å‹å’Œæ—¶é—´å»æ‰)ã€‚

> [!tip] æˆåŠŸç”Ÿæˆä»£ç ä¹‹åä¼šä¿å­˜è®°å½•ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ¬¡ç”Ÿæˆä»£ç ä½¿ç”¨ï¼Œåˆ·æ–°æˆ–é‡æ–°æ‰“å¼€é¡µé¢æ—¶æ˜¾ç¤ºä¸Šä¸€æ¬¡éƒ¨åˆ†å‚æ•°ã€‚

è§£å‹ä»£ç æ–‡ä»¶ï¼Œè¿™æ˜¯åˆ›å»ºçš„grpcç½‘å…³æœåŠ¡ä»£ç ç›®å½•ï¼š

```
.
â”œâ”€ api
â”‚   â””â”€ edusys
â”‚       â””â”€ v1
â”œâ”€ cmd
â”‚   â””â”€ edusys
â”‚       â”œâ”€ initial
â”‚       â””â”€ main.go
â”œâ”€ configs
â”œâ”€ deployments
â”‚   â”œâ”€ binary
â”‚   â”œâ”€ docker-compose
â”‚   â””â”€ kubernetes
â”œâ”€ docs
â”œâ”€ internal
â”‚   â”œâ”€ config
â”‚   â”œâ”€ ecode
â”‚   â”œâ”€ routers
â”‚   â”œâ”€ server
â”‚   â””â”€ service
â””â”€ scripts
```

åˆ›å»ºçš„grpcç½‘å…³æœåŠ¡ä»£ç ç»“æ„é¸¡è›‹æ¨¡å‹ï¼š

![micro-rpc-gw-pb-anatomy](assets/images/micro-rpc-gw-pb-anatomy.png)


<br>

### ğŸ·å¯¹æ¥grpcæœåŠ¡ç›¸å…³æ“ä½œ

#### ğŸ”¹æ·»åŠ è¿æ¥grpcæœåŠ¡ä»£ç 

æƒ³è¦åœ¨grpcç½‘å…³æœåŠ¡é‡Œè°ƒç”¨grpcæœåŠ¡apiæ¥å£ï¼Œé¦–å…ˆè¦èƒ½å¤Ÿè¿æ¥ä¸ŠgrpcæœåŠ¡ï¼Œä¸‹é¢è‡ªåŠ¨ç”ŸæˆgrpcæœåŠ¡è¿æ¥ä»£ç ã€‚

è¿›å…¥spongeçš„UIç•Œé¢ï¼Œç‚¹å‡»å·¦è¾¹èœå•æ ã€Publicã€‘-->ã€ç”ŸæˆgrpcæœåŠ¡è¿æ¥ä»£ç ã€‘ï¼Œå¡«å†™moduleåç§°ï¼Œå¡«å†™grpcæœåŠ¡åç§°(æ”¯æŒå¤šä¸ªgrpcæœåŠ¡åç§°ï¼Œç”¨é€—å·åˆ†éš”)ï¼Œå¡«å†™å®Œå‚æ•°åï¼Œç‚¹å‡»æŒ‰é’®`ä¸‹è½½ä»£ç `ç”ŸæˆgrpcæœåŠ¡è¿æ¥ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![micro-rpc-conn](assets/images/micro-rpc-conn.png)

> [!tip] ç­‰ä»·å‘½ä»¤ **sponge micro rpc-conn --module-name=edusys  --rpc-server-name=user**ã€‚æœ‰æ›´ç®€å•çš„ç­‰ä»·å‘½ä»¤ï¼Œä½¿ç”¨å‚æ•°`--out`æŒ‡å®šgrpcç½‘å…³æœåŠ¡ä»£ç ç›®å½•ï¼Œç›´æ¥åˆå¹¶ä»£ç åˆ°grpcç½‘å…³æœåŠ¡ä»£ç ï¼Œ**sponge micro rpc-conn --rpc-server-name=user --out=edusys**

ç”Ÿæˆçš„grpcæœåŠ¡è¿æ¥ä»£ç ç›®å½•å¦‚ä¸‹ï¼š

```
.
â””â”€ internal
    â””â”€ rpcclient
```

> [!tip] grpcè¿æ¥ä»£ç å…¶å®æ˜¯grpcå®¢æˆ·ç«¯è¿æ¥ä»£ç ï¼ŒåŒ…æ‹¬äº†æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€å®‰å…¨è¿æ¥ã€é“¾è·¯è·Ÿè¸ªã€æŒ‡æ ‡é‡‡é›†ç­‰è®¾ç½®ï¼Œä¹Ÿå¯ä»¥æ·»åŠ è‡ªå·±å®šä¹‰çš„è¿æ¥è®¾ç½®ã€‚

è§£å‹ä»£ç ï¼ŒæŠŠç›®å½•`internal`ç§»åŠ¨åˆ°grpcç½‘å…³æœåŠ¡ä»£ç ç›®å½•ä¸‹ã€‚

> [!note] ç§»åŠ¨ç›®å½•`internal`åˆ°grpcæœåŠ¡ç›®å½•ä¸‹æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæœ‰å†²çªæ–‡ä»¶ï¼Œå¦‚æœæœ‰å†²çªæ–‡ä»¶ï¼Œè¯´æ˜ä¹‹å‰å·²ç»æŒ‡å®šç›¸åŒçš„grpcæœåŠ¡åç§°æ¥ç”ŸæˆgrpcæœåŠ¡è¿æ¥ä»£ç äº†ï¼Œæ­¤æ—¶å¿½ç•¥è¦†ç›–æ–‡ä»¶ã€‚

<br>

#### ğŸ”¹é…ç½®grpcæœåŠ¡åœ°å€

æ·»åŠ è¿æ¥grpcæœåŠ¡ä»£ç ä¹‹åï¼Œåœ¨é…ç½®æ–‡ä»¶`configs/æœåŠ¡åç§°.yml`è®¾ç½®è¿æ¥grpcæœåŠ¡çš„åœ°å€ï¼Œä¸»è¦é…ç½®å†…å®¹å¦‚ä¸‹ï¼š

```yaml
grpcClient:
  - name: "user"        # grpcæœåŠ¡åç§°
    host: "127.0.0.1"   # grpcæœåŠ¡åœ°å€ï¼Œå¦‚æœå¼€å¯æœåŠ¡å‘ç°ï¼Œæ­¤å­—æ®µå€¼æ— æ•ˆ
    port: 8282          # grpcæœåŠ¡ç«¯å£ï¼Œå¦‚æœå¼€å¯æœåŠ¡å‘ç°ï¼Œæ­¤å­—æ®µå€¼æ— æ•ˆ
    registryDiscoveryType: ""  # æœåŠ¡å‘ç°ï¼Œé»˜è®¤å…³é—­ï¼Œæ”¯æŒconsul, etcd, nacos
```

> [!tip] æ›´å¤šgrpcClientè®¾ç½®çœ‹`configs/æœåŠ¡åç§°.yml`ï¼Œä¾‹å¦‚è´Ÿè½½å‡è¡¡ã€å®‰å…¨è¿æ¥ç­‰ã€‚

å¦‚æœè¿æ¥å¤šä¸ªgrpcæœåŠ¡ï¼Œéœ€è¦è®¾ç½®å¤šä¸ªgrpcæœåŠ¡çš„åœ°å€ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
grpcClient:
  - name: "user"
    host: "127.0.0.1"
    port: 18282
    registryDiscoveryType: ""
  - name: "relation"
    host: "127.0.0.1"
    port: 28282
    registryDiscoveryType: ""
  - name: "creation"
    host: "127.0.0.1"
    port: 38282
    registryDiscoveryType: ""
```

<br>

#### ğŸ”¹æ·»åŠ grpcæœåŠ¡çš„protoæ–‡ä»¶

è™½ç„¶åœ¨grpcç½‘å…³æœåŠ¡å¯ä»¥è¿æ¥åˆ°grpcæœåŠ¡ï¼Œä½†æ˜¯ä¸çŸ¥é“grpcæœåŠ¡å“ªäº›apiæ¥å£å¯ä»¥è°ƒç”¨ï¼Œé€šè¿‡protoæ–‡ä»¶å¯ä»¥å‘Šè¯‰grpcç½‘å…³æœåŠ¡å¯ä»¥è°ƒç”¨çš„apiæ¥å£ã€‚

æŠŠgrpcæœåŠ¡ä»£ç ç›®å½•çš„`api/grpcæœåŠ¡åç§°/v1/xxx.proto`æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œå¹¶ç§»åŠ¨åˆ°grpcç½‘å…³æœåŠ¡ä»£ç çš„`api`ç›®å½•ã€‚æœ‰äº†grpcæœåŠ¡protoæ–‡ä»¶ï¼Œgrpcç½‘å…³æœåŠ¡å°±å¯ä»¥çŸ¥é“æœ‰å“ªäº›apiæ¥å£å¯ä»¥è°ƒç”¨äº†ã€‚

åˆ‡æ¢åˆ°grpcç½‘å…³æœåŠ¡ç›®å½•ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```bash
# ä»å…¶ä»–grpcæœåŠ¡ä¸­å¤åˆ¶protoæ–‡ä»¶åˆ°æœ¬æœåŠ¡é¡¹ç›®ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªgrpcæœåŠ¡ç›®å½•ï¼Œç”¨é€—å·åˆ†éš”
make copy-proto SERVER=../user
```

> [!note] `make copy-proto`ä¼šæŠŠæ‰€æœ‰protoæ–‡ä»¶å¤åˆ¶è¿‡æ¥ï¼Œå¦‚æœprotoæ–‡ä»¶å­˜åœ¨ï¼Œä¼šè¦†ç›–protoæ–‡ä»¶ï¼Œå¯ä»¥åœ¨ç›®å½•`/tmp/sponge_copy_backup_proto_files`ä¸‹æ‰¾åˆ°è¦†ç›–å‰çš„å¤‡ä»½protoæ–‡ä»¶ã€‚

<br>

#### ğŸ”¹è¿è¡Œå·²ç»å‡†å¤‡å¥½çš„grpcæœåŠ¡

åœ¨å·²ç»å‡†å¤‡å¥½çš„grpcæœåŠ¡[user](https://github.com/zhufuyi/sponge_examples/tree/main/4_micro-grpc-protobuf)ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```bash
# ç”Ÿæˆä¸åˆå¹¶apiæ¥å£ç›¸å…³ä»£ç 
make proto

# ç¼–è¯‘å’Œè¿è¡ŒæœåŠ¡
make run
```

<br>

### ğŸ·äººå·¥æ·»åŠ apiæ¥å£

åœ¨grpcç½‘å…³æœåŠ¡æ·»åŠ æ–°çš„apiæ¥å£æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æµç¨‹æ˜¯`åœ¨protoæ–‡ä»¶å®šä¹‰apiæ¥å£æè¿°ä¿¡æ¯` --> `åœ¨æ¨¡æ¿æ–‡ä»¶ç¼–å†™å…·ä½“é€»è¾‘ä»£ç `ã€‚

> [!note] `åœ¨protoæ–‡ä»¶å®šä¹‰apiæ¥å£æè¿°ä¿¡æ¯`æ˜¯åœ¨`api/æœåŠ¡åç§°/v1`ç›®å½•ä¸‹çš„protoæ–‡ä»¶æ·»åŠ apiæ¥å£æè¿°ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„protoæ–‡ä»¶ã€‚

<br>

**(1) åœ¨protoæ–‡ä»¶å®šä¹‰apiæ¥å£æè¿°ä¿¡æ¯**

è¿›å…¥ç›®å½•`api/edusys/v1`ç›®å½•ï¼Œæ‰“å¼€æ–‡ä»¶`user_gw.proto`ï¼Œæ·»åŠ ä¿®æ”¹å¯†ç æ¥å£çš„æè¿°ä¿¡æ¯ï¼š

```protobuf
import "validate/validate.proto";
import "tagger/tagger.proto";

service user {
  // ...

  // ä¿®æ”¹å¯†ç 
  rpc ChangePassword(ChangePasswordRequest) returns (ChangeRegisterReply)  {
    option (google.api.http) = {
      post: "/api/v1/user/change_password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "ä¿®æ”¹å¯†ç ",
      description: "ä¿®æ”¹å¯†ç ",
      security: {
        security_requirement: {
          key: "BearerAuth";
          value: {}
        }
      }
    };
  }
}

message ChangePasswordRequest {
  uint64 id = 1 [(validate.rules).uint64.gte  = 1, (tagger.tags) = "uri:\"id\"" ];
  string password = 2 [(validate.rules).string.min_len = 6];
}

message ChangePasswordReply {
}
```

> [!tip] å­—æ®µidå’Œpasswordåé¢çš„`validate.rules`æ˜¯å­—æ®µæ ¡éªŒè§„åˆ™ï¼Œç‚¹å‡»æŸ¥çœ‹æ›´å¤š[validateæ ¡éªŒè§„åˆ™](https://github.com/envoyproxy/protoc-gen-validate#constraint-rules)ï¼Œè€Œ`tagger.tags`æ˜¯ç»“æ„ä½“å­—æ®µtagï¼Œè¿™é‡Œè¡¨ç¤ºè·¯å¾„å‚æ•°idã€‚è®°å¾—åœ¨protoæ–‡ä»¶æ·»åŠ  import "validate/validate.proto" å’Œ "tagger/tagger.proto"ã€‚

æ·»åŠ apiæ¥å£æè¿°ä¿¡æ¯åï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ï¼š

```bash
# ç”Ÿæˆä¸åˆå¹¶apiæ¥å£ç›¸å…³ä»£ç 
make proto
```

> [!note] å¼€å‘è¿‡ç¨‹ä¸­ä¼šç»å¸¸ä½¿ç”¨ `make proto`å‘½ä»¤ï¼Œå†…éƒ¨æ‰§è¡Œä¸€ç³»åˆ—ç”Ÿæˆä»£ç å­å‘½ä»¤ï¼šç”Ÿæˆapiæ¥å£çš„`æ¨¡æ¿ä»£ç `ã€`é”™è¯¯ç `ã€`æ³¨å†Œè·¯ç”±ä»£ç `ã€`swaggeræ–‡æ¡£`ã€`ç›¸å…³çš„*.pb.go`ï¼Œ`è‡ªåŠ¨åˆå¹¶apiæ¥å£æ¨¡æ¿ä»£ç `ã€‚åˆå¹¶ä»£ç æ—¶ä¸ç”¨æ‹…å¿ƒè¦†ç›–å·²ç¼–å†™ä¸šåŠ¡é€»è¾‘ä»£ç é—®é¢˜ï¼Œå°±ç®—å‡ºç°æ„å¤–(æ–­ç”µ)ï¼Œå¯ä»¥åœ¨ `/tmp/sponge_merge_backup_code` ç›®å½•ä¸‹æ‰¾åˆ°æ¯æ¬¡åˆå¹¶å‰çš„å¤‡ä»½ä»£ç ï¼Œå¦‚æœæ˜¯windowsç¯å¢ƒåˆ™å­˜æ”¾åœ¨ `C:\Users\ä½ çš„ç”¨æˆ·å\AppData\Local\Temp\sponge_merge_backup_code`ã€‚å¦‚æœåœ¨protoæ–‡ä»¶æ·»åŠ æˆ–æ›´æ–°äº†apiæ¥å£æè¿°ä¿¡æ¯ï¼Œéœ€è¦æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¦åˆ™ä¸éœ€è¦æ‰§è¡Œã€‚

<br>

**(2) åœ¨æ¨¡æ¿æ–‡ä»¶ç¼–å†™å…·ä½“é€»è¾‘ä»£ç **

æœ‰äº†`è¿æ¥grpcæœåŠ¡ä»£ç `ã€`grpcæœåŠ¡apiæ¥å£`ã€`ç”Ÿæˆçš„æ¨¡æ¿ä»£ç `ä¹‹åï¼Œæ¥ä¸‹æ¥å¯ä»¥ç¼–å†™å…·ä½“é€»è¾‘ä»£ç äº†ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

å¦‚æœåªæ˜¯ç®€å•çš„æŠŠhttpè¯·æ±‚è½¬å‘ç»™grpcæœåŠ¡å¤„ç†ï¼Œç”Ÿæˆçš„æ¨¡æ¿ä»£ç é»˜è®¤å·²ç»å®ç°äº†ï¼Œä¸éœ€è¦å†™goä»£ç ï¼Œåˆ é™¤`panic("implement me")`ï¼Œç„¶åé‡Šæ”¾`example`ä¸‹é¢çš„æ³¨é‡Šä»£ç ï¼Œç„¶åç®€å•çš„è°ƒæ•´ä¸€ä¸‹ä»£ç å³å¯ã€‚ä¾‹å¦‚æ‰“å¼€`internal/service/user_gw.go`æ–‡ä»¶ï¼Œé‡Šæ”¾æ³¨é‡Šåçš„ä»£ç å¦‚ä¸‹ï¼š

```go
package service

import (
	userV1 "edusys/api/user/v1"
    // ......
)

var _ edusysV1.UserLogicer = (*userClient)(nil)

type userClient struct {
	// example:
	userCli userV1.UserClient
}

// NewUserClient create a client
func NewUserClient() edusysV1.UserLogicer {
	return &userClient{
		// example:
		userCli: userV1.NewUserClient(rpcclient.GetUserRPCConn()),
	}
}

// Register æ³¨å†Œ
func (c *userClient) Register(ctx context.Context, req *edusysV1.RegisterRequest) (*edusysV1.RegisterReply, error) {
	// example:
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	reply, err := c.userCli.Register(ctx, &userV1.RegisterRequest{
		Email:    req.Email,
		Password: req.Password,
	})
	if err != nil {
		return nil, err
	}

	return &edusysV1.RegisterReply{
		Id: reply.Id,
	}, nil
}

// Login ç™»å½•
func (c *userClient) Login(ctx context.Context, req *edusysV1.LoginRequest) (*edusysV1.LoginReply, error) {
	// example:
	// ......
}

// Logout ç™»å‡º
func (c *userClient) Logout(ctx context.Context, req *edusysV1.LogoutRequest) (*edusysV1.LogoutReply, error) {
	// example:
	// ......
}

// ChangePassword ä¿®æ”¹å¯†ç 
func (c *userClient) ChangePassword(ctx context.Context, req *edusysV1.ChangePasswordRequest) (*edusysV1.ChangeRegisterReply, error) {
	// example:
	// ......
}
```

<br>

ä¸Šé¢æ˜¯ä»å•ä¸ªgrpcæœåŠ¡ä¸­è·å–æ•°æ®ï¼Œå®é™…ä½¿ç”¨ä¸­æœ‰å¯èƒ½éœ€è¦ä»å¤šä¸ªgrpcæœåŠ¡ä¸­è·å–æ•°æ®ï¼Œç„¶åç»„è£…æˆå®¢æˆ·ç«¯æ‰€éœ€çš„æ•°æ®ï¼Œåªéœ€åœ¨`xxxClient`ç»“æ„ä½“å¼•å…¥å¤šä¸ªgrpcæœåŠ¡clientæ¥å£ï¼Œç„¶åå®ä¾‹åŒ–ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
package service

import (
	userV1 "edusys/api/user/v1"
	relationV1 "edusys/api/relation/v1"
	creationV1 "edusys/api/creation/v1"
    // ......
)

var _ edusysV1.UserLogicer = (*userClient)(nil)

type userClient struct {
	// example:
	userCli userV1.UserClient
	relationCli relationV1.RelationClient
	creationCli creationV1.CreationClient
}

// NewUserClient create a client
func NewUserClient() edusysV1.UserLogicer {
	return &userClient{
		// example:
		userCli: userV1.NewUserClient(rpcclient.GetUserRPCConn()),
		relationCli: userV1.NewRelationClient(rpcclient.GetRelationRPCConn()),
		creationCli: userV1.NewCreationClient(rpcclient.GetCreationRPCConn()),
	}
}

// ......

```

<br>

**(3) è¿è¡Œgrpcç½‘å…³æœåŠ¡**

åˆ‡æ¢åˆ°grpcç½‘å…³æœåŠ¡ä»£ç ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```bash
# ç¼–è¯‘å’Œè¿è¡ŒæœåŠ¡
make run
```

åœ¨æµè§ˆå™¨æ‰“å¼€ [http://localhost:8080/apis/swagger/index.html](http://localhost:8080/apis/swagger/index.html)ï¼Œå¯ä»¥åœ¨é¡µé¢ä¸Šçœ‹åˆ°apiæ¥å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¯·æ±‚apiæ¥å£ï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨grpcæœåŠ¡æ¥å£ã€‚

> [!warning] åœ¨æ²¡æœ‰ç¼–å†™å…·ä½“é€»è¾‘ä»£ç ä¹‹å‰ï¼Œç›´æ¥åœ¨swaggeré¡µé¢è¯·æ±‚ï¼Œä¼šè¿”å›é”™è¯¯ç 500ï¼Œå› ä¸ºç”Ÿæˆçš„æ¨¡æ¿ä»£ç (internal/service/xxx.go)ä¸‹æ¯ä¸ªæ–¹æ³•å‡½æ•°ä¸‹éƒ½æœ‰ä¸€è¡Œä»£ç  `panic("implement me")`ï¼Œæç¤ºéœ€è¦å®ç°å…·ä½“é€»è¾‘ä»£ç ã€‚

![web-http-swagger](assets/images/web-http-pb-swagger.png)

> [!note] å¦‚æœåœ¨é…ç½®æ–‡ä»¶ `configs/æœåŠ¡åç§°.yml` ä¿®æ”¹äº†httpä¸‹çš„ç«¯å£å·ï¼Œä¾‹å¦‚æŠŠé»˜è®¤å€¼8080æ”¹ä¸º9090ï¼Œåˆ™å¿…é¡»åœ¨ç›®å½• `api/user/v1` ä¸‹æ‰€æœ‰protoæ–‡ä»¶é‡Œçš„hostå­—æ®µæ”¹ä¸º `localhost:9090`ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤`make proto`ï¼Œå¦åˆ™å› ä¸ºç«¯å£ä¸ä¸€è‡´é€ æˆè¯·æ±‚å¤±è´¥ã€‚

<br>

### ğŸ·è®¾ç½®grpcç½‘å…³æœåŠ¡

åˆ›å»ºçš„grpcç½‘å…³æœåŠ¡ä»£ç ä¸­åŒ…å«äº†ä¸°å¯Œçš„ç»„ä»¶ï¼Œæœ‰äº›ç»„ä»¶é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ ¹æ®å®é™…éœ€è¦å¼€å¯ä½¿ç”¨ï¼Œç»Ÿä¸€åœ¨é…ç½®æ–‡ä»¶`configs/æœåŠ¡åç§°.yml`è¿›è¡Œè®¾ç½®ï¼Œé…ç½®æ–‡ä»¶é‡Œæœ‰è¯¦ç»†è¯´æ˜ã€‚

> [!tip] å¯ä»¥åœ¨æœåŠ¡ä»£ç ä¸­æ›¿æ¢ã€æ·»åŠ è‡ªå·±çš„ç»„ä»¶(gin middleware)ï¼Œæˆ–è€…åˆ é™¤ä¸éœ€è¦çš„ç»„ä»¶ï¼Œåœ¨ä»£ç æ–‡ä»¶`internal/routers/routers.go`ä¿®æ”¹ã€‚

> [!tip] å¦‚æœapiæ¥å£éœ€è¦æ·»åŠ é‰´æƒï¼Œåœ¨å„ä¸ª`internal/routers/protoæ–‡ä»¶_router.go`ä¸‹ï¼Œé‡Šæ”¾é»˜è®¤æ³¨é‡Šçš„`middleware.Auth()`ä»£ç ï¼Œæ”¯æŒå•ç‹¬è·¯ç”±å’Œåˆ†ç»„è·¯ç”±ä¸¤ç§æ–¹å¼ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„é‰´æƒä¸­é—´ä»¶ï¼Œå¦‚æœä½¿ç”¨è‡ªå·±çš„é‰´æƒä¸­é—´ä»¶ï¼Œéœ€è¦æŠŠ`internal/routers/routers.go`ä¸‹çš„`jwt.Init`æ”¹ä¸ºè‡ªå·±é‰´æƒåˆå§‹åŒ–ã€‚

**é»˜è®¤å¼€å¯çš„ç»„ä»¶ï¼š**

- **logger**ï¼šæ—¥å¿—ç»„ä»¶ï¼Œé»˜è®¤æ˜¯è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œé»˜è®¤è¾“å‡ºæ—¥å¿—æ ¼å¼æ˜¯consoleï¼Œå¯ä»¥è®¾ç½®è¾“å‡ºæ ¼å¼ä¸ºjsonï¼Œè®¾ç½®æ—¥å¿—ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œæ—¥å¿—æ–‡ä»¶åˆ‡å‰²å’Œä¿ç•™æ—¶é—´ã€‚
- **enableMetrics**ï¼šæŒ‡æ ‡é‡‡é›†ï¼Œé»˜è®¤è·¯ç”±`/metrics`ã€‚
- **enableStat**ï¼šèµ„æºç»Ÿè®¡ï¼Œç»Ÿè®¡ç³»ç»Ÿå’Œæœ¬ç¨‹åºçš„cpuå’Œå†…å­˜èµ„æºä½¿ç”¨ä¿¡æ¯ï¼Œé»˜è®¤æ¯åˆ†é’Ÿåœ¨æ—¥å¿—æ‰“å°ä¸€æ¬¡ï¼Œå¦‚æœæœ¬ç¨‹åºå ç”¨ç³»ç»Ÿèµ„æºæŒç»­è¶…è¿‡80%(å¯è®¾ç½®)ï¼Œåå°è‡ªåŠ¨é‡‡é›†profileä¿å­˜åˆ°ç›®å½•`/tmp/æœåŠ¡åç§°_profile`ï¼Œå¯ä»¥åç»­è¿›è¡Œç¦»çº¿åˆ†æã€‚
- **cacheType**ï¼šç¼“å­˜ç»„ä»¶ï¼Œé»˜è®¤æ˜¯æœ¬åœ°å†…å­˜ï¼Œå¯ä»¥æ”¹ä¸ºredisï¼Œæ³¨æ„é›†ç¾¤éƒ¨ç½²æ—¶å¿…é¡»ä½¿ç”¨redisã€‚

**é»˜è®¤å…³é—­çš„ç»„ä»¶ï¼š**

- **enableHTTPProfile**ï¼šprofileç»„ä»¶
- **enableLimit**ï¼šè‡ªé€‚åº”é™æµç»„ä»¶
- **enableCircuitBreaker**ï¼šè‡ªé€‚åº”ç†”æ–­ç»„ä»¶
- **enableTrace**ï¼šé“¾è·¯è·Ÿè¸ªç»„ä»¶
- **registryDiscoveryType**ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°ç»„ä»¶
- **grpcå®¢æˆ·ï¼š**
  - **enableLoadBalance**ï¼šè´Ÿè½½å‡è¡¡
  - **serverSecure**ï¼šé€šè¿‡è¯ä¹¦éªŒè¯ï¼Œæ”¯æŒæœåŠ¡ç«¯éªŒè¯å’ŒåŒå‘éªŒè¯
  - **enableToken**ï¼šé€šè¿‡tokenéªŒè¯

å…¶ä»–é…ç½®çš„å¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®ï¼Œä¹Ÿå¯ä»¥æ·»åŠ é…ç½®ï¼Œå¦‚æœæ·»åŠ æˆ–æ›´æ”¹é…ç½®æ–‡ä»¶å­—æ®µï¼Œéœ€è¦æ›´æ–°å¯¹åº”çš„goç»“æ„ä½“ï¼Œåœ¨æœåŠ¡ä»£ç ç›®å½•ä¸‹çš„ç»ˆç«¯æ‰§è¡Œå‘½ä»¤:

```bash
make update-config
```

<br>

---

ç›¸å…³è§†é¢‘ä»‹ç»ï¼š

- [ä¸€é”®ç”Ÿæˆgrpcç½‘å…³æœåŠ¡é¡¹ç›®ä»£ç ](https://www.bilibili.com/video/BV1mV4y1D7k9/)
